function createEvent(c,a){a=a||[];var b=document.createEvent("Event");return b.initEvent(c),b.name=c,b.data=a,a[0]&&a[0],b}var Downloader={localFolder:null,fileSystemURL:null,fileSystem:null,unzipQueue:[],downloadQueue:[],fileObjects:[],fileObjectInProgress:null,fileObjectInUnzipProgress:null,wifiOnly:!1,autoUnzip:!1,autoRemove:!0,autoCheck:!1,noMedia:!0,loading:!1,unzipping:!1,initialized:!1,transfer:null,retry:3,initialize:function(a){Downloader.setFolder(a.folder),void 0!==a.unzip&&Downloader.setAutoUnzip(a.unzip),void 0!==a.remove&&Downloader.setRemoveAfterUnzip(a.remove),void 0!==a.check&&Downloader.setAutoCheck(a.check),void 0!==a.wifiOnly&&Downloader.setWifiOnly(a.wifiOnly),void 0!==a.noMedia&&Downloader.setNoMedia(a.noMedia),void 0!==a.fileSystem&&(Downloader.fileSystemURL=a.fileSystem),document.addEventListener("DOWNLOADER_downloadError",Downloader.onDownloadError,!1),document.addEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.addEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.addEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.addEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.addEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1),Downloader.getFilesystem()},load:function(b,a,d){if(a=a||null,!Downloader.isInitialized()){document.addEventListener("DOWNLOADER_initialized",function c(e){e.target.removeEventListener("DOWNLOADER_initialized",c,!1),Downloader.load(b,a,d)},!1);return}var c={url:b,name:d||b.replace(/^.*\//,""),md5:a};return Downloader.downloadQueue.push(c),Downloader.isLoading()||Downloader.loadNextInQueue(),c.name},abort:function(){null!==Downloader.transfer&&(Downloader.transfer.abort(),Downloader.transfer=null),Downloader.reset()},unzip:function(a){Downloader.unzipQueue.push(a),Downloader.isUnzipping()||Downloader.unzipNextInQueue()},loadNextInQueue:function(){if(Downloader.downloadQueue.length>0){Downloader.loading=!0;var a=Downloader.downloadQueue.shift();return Downloader.fileObjectInProgress=a,Downloader.transferFile(a),!0}return!1},unzipNextInQueue:function(){if(Downloader.unzipQueue.length>0){Downloader.unzipping=!0;var a=Downloader.unzipQueue.shift();return Downloader.fileObjectInUnzipProgress=a,Downloader._unzip(a),!0}return!1},transferFile:function(a){var b=Downloader.localFolder.nativeURL+"/"+a.name;Downloader.transfer=new FileTransfer,Downloader.transfer.onprogress=function(b){if(b.lengthComputable){var c=Math.floor(b.loaded/b.total*100);document.dispatchEvent(createEvent("DOWNLOADER_downloadProgress",[c,a.name]))}},Downloader.transfer.download(a.url,b,function(a){document.dispatchEvent(createEvent("DOWNLOADER_downloadSuccess",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_downloadError",[a]))})},_unzip:function(b){var a=Downloader.localFolder.nativeURL;zip.unzip(a+"/"+b,a,function(a){0==a?document.dispatchEvent(createEvent("DOWNLOADER_unzipSuccess",[b])):document.dispatchEvent(createEvent("DOWNLOADER_unzipError",[b]))},function(a){var c=Math.floor(a.loaded/a.total*100);document.dispatchEvent(createEvent("DOWNLOADER_unzipProgress",[c,b]))})},check:function(a,b){Downloader.localFolder.getFile(a,{create:!1,exclusive:!1},function(c){md5chksum.file(c,function(c){c==b?document.dispatchEvent(createEvent("DOWNLOADER_fileCheckSuccess",[c,a])):document.dispatchEvent(createEvent("DOWNLOADER_fileCheckFailed",[c,b,a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_fileCheckError",[a]))})},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},removeFile:function(a){Downloader.localFolder.getFile(a,{create:!1,exclusive:!1},function(a){a.remove(function(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoved",[a]))},function(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoveError",[a]))})},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},isLoading:function(){return Downloader.loading},isUnzipping:function(){return Downloader.unzipping},isInitialized:function(){return Downloader.initialized},isWifiOnly:function(){return Downloader.wifiOnly},isAutoUnzip:function(){return Downloader.autoUnzip},isAutoRemove:function(){return Downloader.autoRemove},isAutoCheck:function(){return Downloader.autoCheck},isWifiConnection:function(){return navigator.connection.type==Connection.WIFI},isZipFile:function(a){return!!a.match(/\.zip$/)},isNoMedia:function(){return Downloader.noMedia},setFolder:function(a){Downloader.localFolder=a},setWifiOnly:function(a){Downloader.wifiOnly=a},setNoMedia:function(a){Downloader.noMedia=a},setAutoUnzip:function(a){Downloader.autoUnzip=a},setAutoCheck:function(a){Downloader.autoCheck=a},setRemoveAfterUnzip:function(a){Downloader.autoRemove=a},reset:function(){Downloader.downloadQueue=[],Downloader.unzipQueue=[],Downloader.fileObjects=[],Downloader.fileObjectInProgress=null,Downloader.fileObjectInUnzipProgress=null,Downloader.initialized=!1,Downloader.loading=!1,Downloader.unzipping=!1,Downloader.retry=3},getFilesystem:function(){Downloader.fileSystemURL?window.resolveLocalFileSystemURI(Downloader.fileSystemURL,function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))}):(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[a.root]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))}))},getFolder:function(a,b){a.getDirectory(b,{create:!0,exclusive:!1},function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFolder",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))})},touchNoMedia:function(){Downloader.localFolder.getFile(".nomedia",{create:!0,exclusive:!1},function(a){},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},onDownloadSuccess:function(b){var a=b.data[0];if(Downloader.isAutoCheck()){var c=Downloader.fileObjectInProgress.md5;Downloader.check(a.name,c)}else Downloader.isAutoUnzip()&&Downloader.isZipFile(a.name)&&Downloader.unzip(a.name);Downloader.loadNextInQueue()||(Downloader.loading=!1,Downloader.fileObjectInProgress=null),Downloader.retry=3},onDownloadError:function(a){Downloader.retry>0?(Downloader.transferFile(Downloader.fileObjectInProgress),Downloader.retry--):(Downloader.reset(),document.removeEventListener("DOWNLOADER_onDownloadError",Downloader.onDownloadError,!1),document.removeEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.removeEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.removeEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.removeEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.removeEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1))},onUnzipSuccess:function(a){var b=a.data[0];Downloader.isAutoRemove()&&Downloader.removeFile(b),Downloader.unzipNextInQueue()||(Downloader.unzipping=!1,Downloader.fileObjectInUnzipProgress=null)},onCheckSuccess:function(b){var a=b.data[1];Downloader.isAutoUnzip()&&Downloader.isZipFile(a)&&Downloader.unzip(a)},onGotFileSystem:function(a){a.target.removeEventListener(a.name,Downloader.onGotFileSystem);var b=a.data[0];Downloader.fileSystem=b,Downloader.getFolder(b,Downloader.localFolder)},onGotFolder:function(a){a.target.removeEventListener(a.name,Downloader.onGotFolder);var b=a.data[0];Downloader.localFolder=b,Downloader.initialized=!0,Downloader.isNoMedia()&&Downloader.touchNoMedia(),document.dispatchEvent(createEvent("DOWNLOADER_initialized"))},interface:{obj:null,init:function(a){if(!a.folder){console.error("You have to set a folder to store the downloaded files into.");return}a=a||{},Downloader.initialize(a),Downloader.interface.obj=Downloader},get:function(a,b,c){if(!a){console.error("You have to specify a url where the file is located you wanna download");return}if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}return Downloader.load(a,b,c)},getMultipleFiles:function(c){if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}for(var a=0;a<c.length;a++){var b=c[a];Downloader.load(b.url,b.md5,b.name)}},abort:function(){Downloader.abort()},isInitialized:function(){return Downloader.isInitialized()},setWifiOnly:function(a){Downloader.setWifiOnly(a)},setNoMedia:function(a){Downloader.setNoMedia(a)},setAutoUnzip:function(a){Downloader.setAutoUnzip(a)},setAutoCheck:function(a){Downloader.setAutoCheck(a)},setRemoveAfterUnzip:function(a){Downloader.setRemoveAfterUnzip(a)}}};module.exports=Downloader.interface