function createEvent(e,n){n=n||[];var o=document.createEvent("Event");o.initEvent(e),o.name=e,o.data=n;var t=e;return n[0]&&(t+=" : "+n[0]),o}var Downloader={localFolder:null,fileSystemURL:null,fileSystem:null,unzipQueue:[],downloadQueue:[],fileObjects:[],fileObjectInProgress:null,fileObjectInUnzipProgress:null,wifiOnly:!1,autoUnzip:!1,autoRemove:!0,autoCheck:!1,noMedia:!0,loading:!1,unzipping:!1,initialized:!1,transfer:null,retry:3,initialize:function(e){Downloader.setFolder(e.folder),void 0!==e.unzip&&Downloader.setAutoUnzip(e.unzip),void 0!==e.remove&&Downloader.setRemoveAfterUnzip(e.remove),void 0!==e.check&&Downloader.setAutoCheck(e.check),void 0!==e.wifiOnly&&Downloader.setWifiOnly(e.wifiOnly),void 0!==e.noMedia&&Downloader.setNoMedia(e.noMedia),void 0!==e.fileSystem&&(Downloader.fileSystemURL=e.fileSystem),document.addEventListener("DOWNLOADER_downloadError",Downloader.onDownloadError,!1),document.addEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.addEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.addEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.addEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.addEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1),Downloader.getFilesystem()},load:function(e,n,o){if(n=n||null,!Downloader.isInitialized()){document.addEventListener("DOWNLOADER_initialized",function t(r){r.target.removeEventListener("DOWNLOADER_initialized",t,!1),Downloader.load(e,n,o)},!1);return}var t={url:e,name:o||e.replace(/^.*\//,""),md5:n};return Downloader.downloadQueue.push(t),Downloader.isLoading()||Downloader.loadNextInQueue(),t.name},abort:function(){null!==Downloader.transfer&&(Downloader.transfer.abort(),Downloader.transfer=null),Downloader.reset()},unzip:function(e){Downloader.unzipQueue.push(e),Downloader.isUnzipping()||Downloader.unzipNextInQueue()},loadNextInQueue:function(){if(Downloader.downloadQueue.length>0){Downloader.loading=!0;var e=Downloader.downloadQueue.shift();return Downloader.fileObjectInProgress=e,Downloader.transferFile(e),!0}return!1},unzipNextInQueue:function(){if(Downloader.unzipQueue.length>0){Downloader.unzipping=!0;var e=Downloader.unzipQueue.shift();return Downloader.fileObjectInUnzipProgress=e,Downloader._unzip(e),!0}return!1},transferFile:function(e){var n=Downloader.localFolder.nativeURL+"/"+e.name;Downloader.transfer=new FileTransfer,Downloader.transfer.onprogress=function(n){if(n.lengthComputable){var o=Math.floor(n.loaded/n.total*100);document.dispatchEvent(createEvent("DOWNLOADER_downloadProgress",[o,e.name]))}},Downloader.transfer.download(e.url,n,function(e){document.dispatchEvent(createEvent("DOWNLOADER_downloadSuccess",[e]))},function(e){document.dispatchEvent(createEvent("DOWNLOADER_downloadError",[e]))})},_unzip:function(e){var n=Downloader.localFolder.nativeURL;zip.unzip(n+"/"+e,n,function(n){0==n?document.dispatchEvent(createEvent("DOWNLOADER_unzipSuccess",[e])):document.dispatchEvent(createEvent("DOWNLOADER_unzipError",[e]))},function(n){var o=Math.floor(n.loaded/n.total*100);document.dispatchEvent(createEvent("DOWNLOADER_unzipProgress",[o,e]))})},check:function(e,n){Downloader.localFolder.getFile(e,{create:!1,exclusive:!1},function o(t){md5chksum.file(t,function(o){o==n?document.dispatchEvent(createEvent("DOWNLOADER_fileCheckSuccess",[o,e])):document.dispatchEvent(createEvent("DOWNLOADER_fileCheckFailed",[o,n,e]))},function(e){document.dispatchEvent(createEvent("DOWNLOADER_fileCheckError",[e]))})},function e(n){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[n]))})},removeFile:function(e){Downloader.localFolder.getFile(e,{create:!1,exclusive:!1},function e(n){n.remove(function e(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoved",[n]))},function e(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoveError",[n]))})},function e(n){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[n]))})},isLoading:function(){return Downloader.loading},isUnzipping:function(){return Downloader.unzipping},isInitialized:function(){return Downloader.initialized},isWifiOnly:function(){return Downloader.wifiOnly},isAutoUnzip:function(){return Downloader.autoUnzip},isAutoRemove:function(){return Downloader.autoRemove},isAutoCheck:function(){return Downloader.autoCheck},isWifiConnection:function(){return navigator.connection.type==Connection.WIFI},isZipFile:function(e){return!!e.match(/\.zip$/)},isNoMedia:function(){return Downloader.noMedia},setFolder:function(e){Downloader.localFolder=e},setWifiOnly:function(e){Downloader.wifiOnly=e},setNoMedia:function(e){Downloader.noMedia=e},setAutoUnzip:function(e){Downloader.autoUnzip=e},setAutoCheck:function(e){Downloader.autoCheck=e},setRemoveAfterUnzip:function(e){Downloader.autoRemove=e},reset:function(){Downloader.downloadQueue=[],Downloader.unzipQueue=[],Downloader.fileObjects=[],Downloader.fileObjectInProgress=null,Downloader.fileObjectInUnzipProgress=null,Downloader.initialized=!1,Downloader.loading=!1,Downloader.unzipping=!1,Downloader.retry=3},getFilesystem:function(){Downloader.fileSystemURL?window.resolveLocalFileSystemURL(Downloader.fileSystemURL,function(e){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[e]))},function(e){document.dispatchEvent(createEvent("DOWNLOADER_error",[e]))}):(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[e.root]))},function(e){document.dispatchEvent(createEvent("DOWNLOADER_error",[e]))}))},getFolder:function(e,n){e.getDirectory(n,{create:!0,exclusive:!1},function(e){document.dispatchEvent(createEvent("DOWNLOADER_gotFolder",[e]))},function(e){document.dispatchEvent(createEvent("DOWNLOADER_error",[e]))})},touchNoMedia:function(){Downloader.localFolder.getFile(".nomedia",{create:!0,exclusive:!1},function e(n){},function e(n){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[n]))})},onDownloadSuccess:function(e){var n=e.data[0];if(Downloader.isAutoCheck()){var o=Downloader.fileObjectInProgress.md5;Downloader.check(n.name,o)}else Downloader.isAutoUnzip()&&Downloader.isZipFile(n.name)&&Downloader.unzip(n.name);Downloader.loadNextInQueue()||(Downloader.loading=!1,Downloader.fileObjectInProgress=null),Downloader.retry=3},onDownloadError:function(e){Downloader.retry>0&&null!=Downloader.fileObjectInProgress?(Downloader.transferFile(Downloader.fileObjectInProgress),Downloader.retry--):(Downloader.reset(),document.removeEventListener("DOWNLOADER_onDownloadError",Downloader.onDownloadError,!1),document.removeEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.removeEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.removeEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.removeEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.removeEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1))},onUnzipSuccess:function(e){var n=e.data[0];Downloader.isAutoRemove()&&Downloader.removeFile(n),Downloader.unzipNextInQueue()||(Downloader.unzipping=!1,Downloader.fileObjectInUnzipProgress=null)},onCheckSuccess:function(e){var n=e.data[1];Downloader.isAutoUnzip()&&Downloader.isZipFile(n)&&Downloader.unzip(n)},onGotFileSystem:function(e){e.target.removeEventListener(e.name,Downloader.onGotFileSystem);var n=e.data[0];Downloader.fileSystem=n,Downloader.getFolder(n,Downloader.localFolder)},onGotFolder:function(e){e.target.removeEventListener(e.name,Downloader.onGotFolder);var n=e.data[0];Downloader.localFolder=n,Downloader.initialized=!0,Downloader.isNoMedia()&&Downloader.touchNoMedia(),document.dispatchEvent(createEvent("DOWNLOADER_initialized"))},interface:{obj:null,init:function(e){if(!e.folder){console.error("You have to set a folder to store the downloaded files into.");return}e=e||{},Downloader.initialize(e),Downloader.interface.obj=Downloader},get:function(e,n,o){if(!e){console.error("You have to specify a url where the file is located you wanna download");return}if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}return Downloader.load(e,n,o)},getMultipleFiles:function(e){if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}for(var n=0;n<e.length;n++){var o=e[n];Downloader.load(o.url,o.md5,o.name)}},abort:function(){Downloader.abort()},isInitialized:function(){return Downloader.isInitialized()},setWifiOnly:function(e){Downloader.setWifiOnly(e)},setNoMedia:function(e){Downloader.setNoMedia(e)},setAutoUnzip:function(e){Downloader.setAutoUnzip(e)},setAutoCheck:function(e){Downloader.setAutoCheck(e)},setRemoveAfterUnzip:function(e){Downloader.setRemoveAfterUnzip(e)}}};module.exports=Downloader.interface;
